{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="text-center text-primary mb-4">
    <i class="fas fa-shopping-cart"></i> Place Orders / Auto / Stop-Loss
  </h2>

  <ul class="nav nav-tabs" id="orderTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
        <i class="fas fa-hand-point-right"></i> Manual Order
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto" type="button" role="tab">
        <i class="fas fa-robot"></i> Auto Trading with Stop-Loss
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="explain-tab" data-bs-toggle="tab" data-bs-target="#explain" type="button" role="tab">
        <i class="fas fa-info-circle"></i> Explanation
      </button>
    </li>
  </ul>

  <div class="tab-content p-4 bg-white border rounded-bottom">
    <!-- MANUAL TRADE -->
    <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
      <h5 class="text-primary"><i class="fas fa-hand-point-right"></i> Manual Trade</h5>
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="mb-3">
          {{ form.user_id.label(class="form-label") }}
          {{ form.user_id(class="form-select") }}
        </div>
        <div class="mb-3">
          {{ form.symbol.label(class="form-label") }}
          {{ form.symbol(class="form-control", placeholder="e.g. INFY") }}
        </div>
        <div class="mb-3">
          {{ form.transaction_type.label(class="form-label") }}
          {{ form.transaction_type(class="form-select") }}
        </div>
        <div class="mb-3">
          {{ form.price.label(class="form-label") }}
          {{ form.price(class="form-control", placeholder="Enter Price") }}
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-paper-plane"></i> {{ form.submit.label.text }}
        </button>
      </form>
    </div>

    <!-- AUTO TRADING WITH STOP-LOSS -->
    <div class="tab-pane fade" id="auto" role="tabpanel" aria-labelledby="auto-tab">
      <h5 class="text-success"><i class="fas fa-robot"></i> Auto Trade (Buy) with Stop-Loss</h5>
      <form id="auto-trade-form">
        <div class="row g-3 mb-2">
          <div class="col-md-4">
            <label class="form-label">Select User ID</label>
            <select id="auto_user" class="form-select">
              {% for u in users %}
              <option value="{{ u.id }}">{{ u.username }} ({{u.broker}})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Symbol</label>
            <input type="text" id="auto_symbol" class="form-control" placeholder="INFY">
          </div>
          <div class="col-md-4">
            <label class="form-label">Condition</label>
            <select id="auto_condition" class="form-select">
              <option value="Condition 1">Condition 1 (>= threshold)</option>
              <option value="Condition 2">Condition 2 (> threshold)</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mb-2">
          <div class="col-md-4">
            <label class="form-label">Basis</label>
            <select id="auto_basis" class="form-select">
              <option value="fixed">Fixed</option>
              <option value="points">Points</option>
              <option value="percentage">Percentage</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Threshold Value</label>
            <input type="number" step="0.01" id="auto_threshold" class="form-control" placeholder="1500">
          </div>
          <div class="col-md-4">
            <label class="form-label">Reference Price</label>
            <input type="number" step="0.01" id="auto_reference" class="form-control" placeholder="Optional">
          </div>
        </div>
        <h6 class="text-danger mt-4"><i class="fas fa-shield-alt"></i> Stop-Loss Configuration</h6>
        <div class="row g-3 mb-2">
          <div class="col-md-4">
            <label class="form-label">Stop-Loss Type</label>
            <select id="sl_type" class="form-select">
              <option value="percentage">Percentage</option>
              <option value="points">Points</option>
              <option value="fixed">Fixed</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Stop-Loss Value</label>
            <input type="number" step="0.01" id="sl_value" class="form-control" placeholder="Enter SL value">
          </div>
        </div>
        <button type="button" class="btn btn-success me-2 mt-2" onclick="startAutoTrade()"><i class="fas fa-play"></i> Start Auto</button>
        <button type="button" class="btn btn-danger mt-2" onclick="stopAutoTrade()"><i class="fas fa-stop"></i> Stop Auto</button>
      </form>
    </div>

    <!-- EXPLANATION -->
    <div class="tab-pane fade" id="explain" role="tabpanel" aria-labelledby="explain-tab">
      <h5><i class="fas fa-info-circle"></i> Explanation of Auto Trading with Stop-Loss</h5>
      <h6><strong>Conditions:</strong></h6>
      <ul>
        <li><strong>Condition 1:</strong> If the price is greater than or equal to the threshold value, a trade will be placed. <br>
          Example: If the threshold is 1500, and the live price is 1500 or higher, the condition is met.</li>
        <li><strong>Condition 2:</strong> If the price is strictly greater than the threshold value, a trade will be placed. <br>
          Example: If the threshold is 1500, and the live price is 1501, the condition is met.</li>
      </ul>
      <h6><strong>Stop-Loss Types:</strong></h6>
      <ul>
        <li><strong>Percentage:</strong> Stop-loss is calculated as a percentage of the entry price. <br>
          Example: Entry price = 1000, SL = 5%. SL will trigger at 950.</li>
        <li><strong>Points:</strong> Stop-loss is calculated by subtracting a fixed number of points from the entry price. <br>
          Example: Entry price = 1000, SL = 10 points. SL will trigger at 990.</li>
        <li><strong>Fixed:</strong> Stop-loss is set at a fixed value. <br>
          Example: Fixed SL = 950. SL will trigger if the price drops to 950 or below.</li>
      </ul>
      <h6><strong>Quantity:</strong></h6>
      <ul>
        <li>The **quantity** is fetched automatically from the user data (as entered in the registration form).</li>
        <li>Example: If the userâ€™s default quantity is 10, every auto trade will use a quantity of 10 unless explicitly updated in the registration form.</li>
      </ul>
    </div>
  </div>
</div>

<script>
function startAutoTrade() {
  const data = {
    user_id: parseInt(document.getElementById('auto_user').value),
    symbol: document.getElementById('auto_symbol').value,
    condition: document.getElementById('auto_condition').value,
    basis: document.getElementById('auto_basis').value,
    threshold_value: parseFloat(document.getElementById('auto_threshold').value || '0'),
    reference_price: parseFloat(document.getElementById('auto_reference').value || '0'),
    stop_loss_type: document.getElementById('sl_type').value,
    stop_loss_value: parseFloat(document.getElementById('sl_value').value || '0')
  };
  fetch('/api/auto_trade', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(resp => alert(resp.message))
  .catch(err => console.error(err));
}

function stopAutoTrade() {
  const user_id = parseInt(document.getElementById('auto_user').value);
  fetch('/api/stop_auto_trade', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id})
  })
  .then(r => r.json())
  .then(resp => alert(resp.message))
  .catch(err => console.error(err));
}
</script>
{% endblock %}
